FROM python:3.11-slim

WORKDIR /app

# å¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨curlã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ï¼‰
RUN apt-get update && apt-get install -y \
    libsndfile1 \
    libgomp1 \
    curl \
    ffmpeg \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# requirements.txtã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# âœ… PaSSTãƒ¢ãƒ‡ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå®Ÿè¡Œæ™‚ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚é–“ã‚’æ’é™¤ï¼‰
# ã“ã‚Œã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚é–“ãŒæ•°åˆ†ã‹ã‚‰æ•°ç§’ã«çŸ­ç¸®ã•ã‚Œã¾ã™
RUN python3 -c "\
from hear21passt.base import get_basic_model, get_model_passt; \
import torch; \
print('ğŸ”§ PaSSTãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...'); \
model = get_basic_model(mode='logits'); \
print('âœ… PaSSTãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†'); \
"

# AudioSetãƒ©ãƒ™ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY audioset_labels.json .

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼
COPY main_supabase.py main.py
COPY main.py main_simple.py

# Pythonç’°å¢ƒå¤‰æ•°ã®è¨­å®š
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# ãƒãƒ¼ãƒˆã‚’å…¬é–‹ï¼ˆPaSSTã¯8017ã§å‹•ä½œ - v2ã¨åŒã˜ï¼‰
EXPOSE 8017

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šï¼ˆstart_periodã‚’60ç§’ã«è¨­å®šï¼šåˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ã‚’è€ƒæ…®ï¼‰
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8017/health || exit 1

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8017", "--log-level", "info"]
